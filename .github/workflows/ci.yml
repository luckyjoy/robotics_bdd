name: ðŸ¤– Robotics BDD Simulation CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ github.run_number }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests with Allure
        run: |
          pytest --alluredir=allure-results || echo "Tests failed but continuing"

      - name: Generate Allure Report
        run: |
          allure generate allure-results --clean -o allure-report || echo "Report generation failed"

      - name: Upload Allure Report for deploy job
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/

  deploy:
    runs-on: ubuntu-latest
    needs: test
    env:
      SITE_DIR: site

    steps:
      - uses: actions/checkout@v4

      - name: Download Allure Report from test job
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Restore existing gh-pages (preserve history)
        run: |
          mkdir -p old_site
          git fetch origin gh-pages || true
          git checkout origin/gh-pages -- . || true
          cp -r . old_site || true

      - name: Determine build number
        run: echo "BUILD_NUM=${{ needs.test.outputs.build_number }}" >> $GITHUB_ENV

      - name: Merge old builds + new build
        run: |
          mkdir -p "${{ env.SITE_DIR }}/history"
          if [ -d old_site/history ]; then
            cp -r old_site/history/* "${{ env.SITE_DIR }}/history/" || true
          fi
          cp -r allure-report "${{ env.SITE_DIR }}/history/build-${{ env.BUILD_NUM }}"

      - name: Generate index.html dashboard
        run: |
          CURRENT_TIME=$(TZ="America/Los_Angeles" date)
          mkdir -p "${{ env.SITE_DIR }}"
          INDEX="${{ env.SITE_DIR }}/index.html"

          echo "<!DOCTYPE html><html><head><meta charset='UTF-8'>
          <title>ðŸ¤– Robotics BDD Simulation CI/CD Dashboard</title>
          <style>
            body { font-family: Arial, sans-serif; background: #fafafa; padding: 20px; }
            h1,h2 { color: #222; }
            ul { line-height: 1.6; }
            a { color: #0078d7; text-decoration: none; }
            a:hover { text-decoration: underline; }
          </style>
          </head><body>
          <h1>ðŸ¤– Robotics BDD Simulation CI/CD</h1>
          <h2>ðŸ“Š Report History & Trends</h2><hr>" > "$INDEX"

          echo "<ul>" >> "$INDEX"
          for dir in $(ls -r "${{ env.SITE_DIR }}/history"); do
            BUILD_NUM=$(echo $dir | sed 's/build-//')
            echo "<li>Build #${BUILD_NUM} â†’ <a href='history/${dir}/index.html'>Allure Report</a></li>" >> "$INDEX"
          done
          echo "</ul><hr>" >> "$INDEX"
          echo "<p><em>Generated: $CURRENT_TIME</em></p></body></html>" >> "$INDEX"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Add Workflow Summary (Badges)
        run: |
          PAGE_URL=${{ steps.deployment.outputs.page_url }}
          BASE_URL="${PAGE_URL%/}"
          TEST_STATUS=${{ needs.test.outputs.test_outcome }}

          if [[ "$TEST_STATUS" == "FAIL" ]]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="Failed (setup/config error)"
          elif [[ "$TEST_STATUS" == "UNSTABLE" ]]; then
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="Unstable (some tests failed)"
          else
            STATUS_ICON="âœ…"
            STATUS_TEXT="All tests passed"
          fi

          echo "### ðŸ¤– Robotics BDD Simulation CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[![Ubuntu Latest Report](https://img.shields.io/badge/Ubuntu-Latest_Build-blue)](${BASE_URL}/latest/ubuntu-latest/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "[![Windows Latest Report](https://img.shields.io/badge/Windows-Latest_Build-blue)](${BASE_URL}/latest/windows-latest/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "[![Report History](https://img.shields.io/badge/All-Builds-green)](${BASE_URL}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build #${{ github.run_number }} | Status: $STATUS_ICON $STATUS_TEXT" >> $GITHUB_STEP_SUMMARY
