name: 🤖 Robotics BDD Simulation CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  ALLURE_VERSION: 2.29.0
  SITE_DIR: site

jobs:
  test:
    name: 🧪 Run Tests
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    outputs:
      test_outcome: ${{ steps.outcome.outputs.result }}
      build_number: ${{ github.run_number }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build Docker image (Linux only)
        if: matrix.os == 'ubuntu-latest'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: robotics-bdd:ci-build
          load: true

      - name: Run tests with Allure
        id: run_tests
        shell: bash
        run: |
          mkdir -p allure-results
          TEST_EXIT_CODE=1
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            echo "🐳 Running tests in Docker..."
            docker run --rm -v $PWD:/workspace -w /workspace robotics-bdd:ci-build \
              pytest -v --alluredir=allure-results
            TEST_EXIT_CODE=$?
          else
            echo "🪟 Running tests on Windows..."
            pytest -v --alluredir=allure-results
            TEST_EXIT_CODE=$?
          fi
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          # Save test status for report aggregation
          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "status=PASS" > test_status.txt
          else
            echo "status=UNSTABLE" > test_status.txt
          fi

      - name: Generate Allure report (Cross-platform)
        shell: bash
        run: |
          set -e
          echo "Generating Allure report on ${{ runner.os }}..."

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            pwsh -Command "Invoke-WebRequest -Uri https://github.com/allure-framework/allure2/releases/download/${{ env.ALLURE_VERSION }}/allure-${{ env.ALLURE_VERSION }}.tgz -OutFile allure-${{ env.ALLURE_VERSION }}.tgz"
            tar -xzf allure-${ALLURE_VERSION}.tgz
            mv allure-${ALLURE_VERSION} allure
            ./allure/bin/allure generate allure-results --clean -o allure-report || true
          else
            wget -q https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz
            tar -xzf allure-${ALLURE_VERSION}.tgz
            mv allure-${ALLURE_VERSION} allure
            ./allure/bin/allure generate allure-results --clean -o allure-report || true
          fi

      - name: Determine overall outcome
        id: outcome
        shell: bash
        run: |
          CODE=${{ steps.run_tests.outputs.test_exit_code }}
          if [[ "${{ job.status }}" == "failure" ]]; then
            echo "result=FAIL" >> $GITHUB_OUTPUT
          elif [ "$CODE" -eq 0 ]; then
            echo "result=PASS" >> $GITHUB_OUTPUT
          else
            echo "result=UNSTABLE" >> $GITHUB_OUTPUT
          fi

      - name: Upload Allure report artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.os }}
          path: |
            allure-report/
            test_status.txt

  report:
    name: 📊 Generate Dashboard & Deploy
    runs-on: ubuntu-latest
    needs: test
    env:
      SITE_DIR: site

    steps:
      - uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          path: allure-downloads

      - name: Restore history & merge new reports
        run: |
          BUILD=${{ needs.test.outputs.build_number }}
          mkdir -p ${SITE_DIR}/builds

          echo "⬇️ Attempting to download previous build history..."
          gh run download -n "allure-history" -D previous || echo "⚠️ No previous history found."

          if [ -d previous/${SITE_DIR}/builds ]; then
            cp -r previous/${SITE_DIR}/builds/* ${SITE_DIR}/builds/ || true
          fi

          mkdir -p ${SITE_DIR}/builds/${BUILD}
          CURRENT_BUILD_STATUS_FILE="${SITE_DIR}/builds/${BUILD}/status.txt"

          for OS_DIR in allure-downloads/*; do
            if [ -d "$OS_DIR/allure-report" ]; then
              OS_NAME=$(basename "$OS_DIR" | sed 's/allure-report-//')
              mkdir -p "${SITE_DIR}/builds/${BUILD}/${OS_NAME}"
              cp -r "$OS_DIR/allure-report/"* "${SITE_DIR}/builds/${BUILD}/${OS_NAME}/"

              if [ -f "$OS_DIR/test_status.txt" ]; then
                STATUS_FROM_FILE=$(cut -d= -f2 "$OS_DIR/test_status.txt")
                if [ "$STATUS_FROM_FILE" = "UNSTABLE" ]; then
                  echo "status=UNSTABLE" > "$CURRENT_BUILD_STATUS_FILE"
                elif [ ! -f "$CURRENT_BUILD_STATUS_FILE" ]; then
                  echo "status=PASS" > "$CURRENT_BUILD_STATUS_FILE"
                fi
              fi
            fi
          done

          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "status=FAIL" > "$CURRENT_BUILD_STATUS_FILE"
          fi

          rm -rf ${SITE_DIR}/latest
          cp -r ${SITE_DIR}/builds/${BUILD} ${SITE_DIR}/latest

      - name: Generate index.html (Trend + History)
        run: |
          mkdir -p ${SITE_DIR}
          INDEX=${SITE_DIR}/index.html
          NOW=$(TZ='America/Los_Angeles' date)
          cat << EOF_HEADER > $INDEX
          <html><head><title>🤖 Robotics BDD Dashboard</title>
          <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
          <style>
          body{font-family:sans-serif;margin:20px;}
          a{color:#0366d6;text-decoration:none;}
          a:hover{text-decoration:underline;}
          </style></head><body>
          <h1>🤖 Robotics BDD Simulation CI/CD</h1>
          <h2>📊 Report History & Trends</h2><hr><ul>
          EOF_HEADER

          LABELS="";PASS_COUNT="";FAIL_COUNT="";UNSTABLE_COUNT=""

          for B in $(find ${SITE_DIR}/builds -mindepth 1 -maxdepth 1 -type d | sort -V); do
            N=$(basename "$B")
            echo "<li>Build #$N →" >> $INDEX
            for O in $(ls "$B" | grep -v 'status.txt'); do
              echo " <a href='builds/$N/$O/index.html'>$O Report</a>" >> $INDEX
            done
            echo "</li>" >> $INDEX

            STATUS="FAIL"
            if [ -f "$B/status.txt" ]; then
              STATUS=$(cut -d= -f2 "$B/status.txt")
            fi

            LABELS="$LABELS'$N',"
            if [ "$STATUS" == "PASS" ]; then
              PASS_COUNT="$PASS_COUNT 1,"; FAIL_COUNT="$FAIL_COUNT 0,"; UNSTABLE_COUNT="$UNSTABLE_COUNT 0,"
            elif [ "$STATUS" == "FAIL" ]; then
              PASS_COUNT="$PASS_COUNT 0,"; FAIL_COUNT="$FAIL_COUNT 1,"; UNSTABLE_COUNT="$UNSTABLE_COUNT 0,"
            else
              PASS_COUNT="$PASS_COUNT 0,"; FAIL_COUNT="$FAIL_COUNT 0,"; UNSTABLE_COUNT="$UNSTABLE_COUNT 1,"
            fi
          done

          cat << EOF_FOOTER >> $INDEX
          </ul><canvas id='trend' width='900' height='400'></canvas>
          <script>
          const ctx=document.getElementById('trend').getContext('2d');
          new Chart(ctx,{
            type:'line',
            data:{
              labels:[${LABELS}],
              datasets:[
                {label:'PASS',data:[${PASS_COUNT}],borderColor:'green',fill:false},
                {label:'FAIL',data:[${FAIL_COUNT}],borderColor:'red',fill:false},
                {label:'UNSTABLE',data:[${UNSTABLE_COUNT}],borderColor:'orange',fill:false}
              ]},
            options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});
          </script>
          <hr><p><em>Generated: $NOW</em></p></body></html>
          EOF_FOOTER

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

      - name: Deploy Dashboard via GitHub Actions
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Save build history for next runs
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: ${{ env.SITE_DIR }}
          retention-days: 10

      - name: Add Workflow Summary
        run: |
          PAGE_URL=${{ steps.deploy.outputs.page_url }}
          BASE_URL="${PAGE_URL%/}"
          TEST_STATUS=${{ needs.test.outputs.test_outcome }}

          if [[ "$TEST_STATUS" == "FAIL" ]]; then
            STATUS_ICON="❌"
            STATUS_TEXT="Fail — setup/config/env issue"
          elif [[ "$TEST_STATUS" == "UNSTABLE" ]]; then
            STATUS_ICON="⚠️"
            STATUS_TEXT="Unstable — tests failed but env OK"
          else
            STATUS_ICON="✅"
            STATUS_TEXT="Pass — all tests succeeded"
          fi

          echo "### 🤖 Robotics BDD Simulation CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[![Ubuntu Report](https://img.shields.io/badge/Ubuntu-Latest_Build-blue)](${BASE_URL}/latest/ubuntu-latest/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "[![Windows Report](https://img.shields.io/badge/Windows-Latest_Build-blue)](${BASE_URL}/latest/windows-latest/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "[![History](https://img.shields.io/badge/All_Builds-green)](${BASE_URL}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build #${{ github.run_number }} | Status: $STATUS_ICON $STATUS_TEXT" >> $GITHUB_STEP_SUMMARY
