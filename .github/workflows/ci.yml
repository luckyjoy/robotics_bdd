name: 🤖 Robotics BDD Simulation CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  ALLURE_VERSION: 2.29.0
  SITE_DIR: site

jobs:
  test:
    name: 🧪 Run Tests
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    outputs:
      test_outcome: ${{ steps.outcome.outputs.result }}
      build_number: ${{ github.run_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build Docker image (Linux only)
        if: matrix.os == 'ubuntu-latest'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: robotics-bdd:ci-build
          load: true

      - name: Run tests (Docker on Linux, pytest on Windows)
        id: run_tests
        shell: bash
        run: |
          set -e
          mkdir -p allure-results

          TEST_EXIT_CODE=1
          echo "Starting tests for ${{ matrix.os }}..."

          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            echo "🐳 Running tests inside Docker..."
            # Run tests inside Docker, capture exit code
            docker run --rm -v "$PWD":/workspace -w /workspace robotics-bdd:ci-build \
              pytest -v --alluredir=allure-results || TEST_EXIT_CODE=$?
          else
            echo "🪟 Running tests on Windows..."
            pytest -v --alluredir=allure-results || TEST_EXIT_CODE=$?
          fi

          echo "Test exit code: $TEST_EXIT_CODE"
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

          # Test status logic (for per-OS report)
          # PASS: exit code 0
          # UNSTABLE: exit code > 0 (tests failed, but env okay)
          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "status=PASS" > test_status.txt
          else
            echo "status=UNSTABLE" > test_status.txt
          fi

      - name: Generate Allure report
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz
          tar -xzf allure-${ALLURE_VERSION}.tgz
          mv allure-${ALLURE_VERSION} allure
          ./allure/bin/allure generate allure-results --clean -o allure-report || true

      - name: Determine overall test outcome
        id: outcome
        shell: bash
        run: |
          CODE=${{ steps.run_tests.outputs.test_exit_code }}
          # Job failure detection: if setup/config/env failed before tests even ran
          if [[ "${{ job.status }}" == "failure" ]]; then
            echo "result=FAIL" >> $GITHUB_OUTPUT
          elif [ "$CODE" -eq 0 ]; then
            echo "result=PASS" >> $GITHUB_OUTPUT
          else
            echo "result=UNSTABLE" >> $GITHUB_OUTPUT
          fi

      - name: Upload Allure report and test status
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.os }}
          path: |
            allure-report/
            test_status.txt

  report:
    name: 📊 Generate Dashboard & Deploy
    runs-on: ubuntu-latest
    needs: test
    env:
      SITE_DIR: site

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Allure artifacts
        uses: actions/download-artifact@v4
        with:
          path: allure-downloads

      - name: Restore previous build history
        shell: bash
        run: |
          mkdir -p previous
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y gh || true
          fi
          echo "📦 Attempting to restore previous 'allure-history'..."
          gh run download -n "allure-history" -D previous || echo "ℹ️ No previous history found."
          mkdir -p ${SITE_DIR}/builds
          if [ -d previous/${SITE_DIR}/builds ]; then
            cp -r previous/${SITE_DIR}/builds/* ${SITE_DIR}/builds/ || true
          fi

      - name: Consolidate current build
        shell: bash
        run: |
          BUILD=${{ needs.test.outputs.build_number }}
          mkdir -p ${SITE_DIR}/builds/${BUILD}

          # Merge new reports per OS
          for OS_DIR in allure-downloads/*; do
            if [ -d "$OS_DIR/allure-report" ]; then
              OS_NAME=$(basename "$OS_DIR" | sed 's/allure-report-//')
              mkdir -p "${SITE_DIR}/builds/${BUILD}/${OS_NAME}"
              cp -r "$OS_DIR/allure-report/"* "${SITE_DIR}/builds/${BUILD}/${OS_NAME}/"
              cp "$OS_DIR/test_status.txt" "${SITE_DIR}/builds/${BUILD}/${OS_NAME}_status.txt" || true
            fi
          done

          # Determine overall build status
          BUILD_STATUS_FILE="${SITE_DIR}/builds/${BUILD}/status.txt"
          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "status=FAIL" > "$BUILD_STATUS_FILE"
          else
            OVERALL="PASS"
            for f in ${SITE_DIR}/builds/${BUILD}/*_status.txt; do
              [ -e "$f" ] || continue
              S=$(cut -d= -f2 "$f")
              if [ "$S" = "UNSTABLE" ]; then
                OVERALL="UNSTABLE"
              fi
            done
            echo "status=$OVERALL" > "$BUILD_STATUS_FILE"
          fi

          # Update 'latest' link
          rm -rf ${SITE_DIR}/latest
          cp -r ${SITE_DIR}/builds/${BUILD} ${SITE_DIR}/latest

      - name: Generate index.html (history + trend)
        shell: bash
        run: |
          mkdir -p ${SITE_DIR}
          INDEX=${SITE_DIR}/index.html
          NOW=$(TZ='America/Los_Angeles' date)
          echo "Building trend report..."

          cat << 'HTML_TOP' > $INDEX
          <html><head><title>🤖 Robotics BDD Dashboard</title>
          <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
          <style>
          body{font-family:sans-serif;margin:20px;}
          a{color:#0366d6;text-decoration:none;}
          a:hover{text-decoration:underline;}
          </style></head><body>
          <h1>🤖 Robotics BDD Simulation CI/CD</h1>
          <h2>📊 Report History & Trends</h2><hr><ul>
          HTML_TOP

          LABELS="";PASS="";FAIL="";UNSTABLE=""
          for B in $(find ${SITE_DIR}/builds -mindepth 1 -maxdepth 1 -type d | sort -V); do
            N=$(basename "$B")
            echo "<li>Build #$N →" >> $INDEX
            for O in $(ls "$B" | grep -v 'status.txt' | grep -v '_status.txt' || true); do
              echo " <a href='builds/$N/$O/index.html'>$O</a>" >> $INDEX
            done
            echo "</li>" >> $INDEX

            STATUS="FAIL"
            if [ -f "$B/status.txt" ]; then
              STATUS=$(cut -d= -f2 "$B/status.txt")
            fi

            LABELS="$LABELS'$N',"
            case "$STATUS" in
              PASS) PASS="$PASS 1,"; FAIL="$FAIL 0,"; UNSTABLE="$UNSTABLE 0," ;;
              FAIL) PASS="$PASS 0,"; FAIL="$FAIL 1,"; UNSTABLE="$UNSTABLE 0," ;;
              UNSTABLE) PASS="$PASS 0,"; FAIL="$FAIL 0,"; UNSTABLE="$UNSTABLE 1," ;;
            esac
          done

          cat << HTML_BOTTOM >> $INDEX
          </ul><canvas id='trend' width='900' height='400'></canvas>
          <script>
          const ctx=document.getElementById('trend').getContext('2d');
          new Chart(ctx,{
            type:'line',
            data:{
              labels:[${LABELS}],
              datasets:[
                {label:'PASS',data:[${PASS}],borderColor:'green',fill:false},
                {label:'FAIL',data:[${FAIL}],borderColor:'red',fill:false},
                {label:'UNSTABLE',data:[${UNSTABLE}],borderColor:'orange',fill:false}
              ]},
            options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});
          </script>
          <hr><p><em>Generated: $NOW</em></p></body></html>
          HTML_BOTTOM

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

      - name: Deploy Dashboard via GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Save history for next run
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: ${{ env.SITE_DIR }}
          retention-days: 10

      - name: Add Workflow Summary (Badges)
        run: |
          PAGE_URL=${{ steps.deployment.outputs.page_url }}
          BASE_URL="${PAGE_URL%/}"
          TEST_STATUS=${{ needs.test.outputs.test_outcome }}

          if [[ "$TEST_STATUS" == "FAIL" ]]; then
            ICON="❌"
            TEXT="Failed (setup/config error)"
          elif [[ "$TEST_STATUS" == "UNSTABLE" ]]; then
            ICON="⚠️"
            TEXT="Unstable (one or more tests failed)"
          else
            ICON="✅"
            TEXT="All tests passed"
          fi

          echo "### 🤖 Robotics BDD Simulation CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[![Ubuntu Report](https://img.shields.io/badge/Ubuntu-Latest_Build-blue)](${BASE_URL}/latest/ubuntu-latest/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "[![Windows Report](https://img.shields.io/badge/Windows-Latest_Build-blue)](${BASE_URL}/latest/windows-latest/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "[![All Builds](https://img.shields.io/badge/All-Builds-green)](${BASE_URL}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build #${{ github.run_number }} | Status: $ICON $TEXT" >> $GITHUB_STEP_SUMMARY
