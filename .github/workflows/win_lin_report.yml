name: Robotics BDD Simulation CI/CD

on:
  push:
  pull_request:

env:
  ALLURE_VERSION: 2.29.0
  SITE_DIR: site

jobs:
  # =========================
  # 1Ô∏è‚É£ Test on Ubuntu
  # =========================
  test_ubuntu:
    name: Run Tests (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install allure-pytest

      - name: Run Tests with Allure
        run: |
          mkdir -p allure-results/ubuntu-latest
          pytest tests/ --alluredir=allure-results/ubuntu-latest || echo "TEST_FAILURE=true" >> $GITHUB_ENV

      - name: Save Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-results
          path: allure-results/ubuntu-latest/

  # =========================
  # 2Ô∏è‚É£ Test on Windows
  # =========================
  test_windows:
    name: Run Tests (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install allure-pytest

      - name: Run Tests with Allure
        run: |
          mkdir -p allure-results/windows-latest
          pytest tests/ --alluredir=allure-results/windows-latest || echo "TEST_FAILURE=true" >> $env:GITHUB_ENV

      - name: Save Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-results
          path: allure-results/windows-latest/

  # =========================
  # 3Ô∏è‚É£ Deploy & Determine Build Result
  # =========================
  deploy_allure:
    name: Deploy Allure Report
    runs-on: ubuntu-latest
    needs: [test_ubuntu, test_windows]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Download Test Artifacts
        uses: actions/download-artifact@v4
        with:
          path: allure-results

      - name: Copy Executor Info
        run: |
          if [ -f "$PWD/supports/executor.json" ]; then
            echo "Copying executor.json to allure-results/"
            cp "$PWD/supports/executor.json" "$PWD/allure-results/"
          else
            echo "‚ö†Ô∏è executor.json not found at supports/executor.json"
          fi

      - name: Install Allure
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.zip
          unzip allure-${ALLURE_VERSION}.zip -d /opt/allure
          export PATH="/opt/allure/allure-${ALLURE_VERSION}/bin:$PATH"

      - name: Determine Build Result
        id: build_result
        run: |
          BUILD_STATUS="pass"

          # CASE 3: setup/config/env errors
          if [ "${{ needs.test_ubuntu.result }}" = "failure" ] || [ "${{ needs.test_windows.result }}" = "failure" ]; then
            BUILD_STATUS="fail"
          else
            # CASE 2: tests failed but environment OK
            UB_FAILS=$(grep -o '"status":"failed"' allure-results/ubuntu-latest/*.json 2>/dev/null | wc -l)
            WIN_FAILS=$(grep -o '"status":"failed"' allure-results/windows-latest/*.json 2>/dev/null | wc -l)

            if [ "$UB_FAILS" -gt 0 ] || [ "$WIN_FAILS" -gt 0 ]; then
              BUILD_STATUS="unstable"
            fi
          fi

          echo "Final build status: $BUILD_STATUS"
          echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT

      - name: Generate Allure Reports
        run: |
          mkdir -p "$SITE_DIR/latest"
          for OS in ubuntu-latest windows-latest; do
            if [ -d "allure-results/$OS" ]; then
              mkdir -p "$SITE_DIR/latest/$OS"
              allure generate "allure-results/$OS" -o "$SITE_DIR/latest/$OS" --clean
              echo "$(date '+%Y-%m-%d %H:%M:%S %Z')" > "$SITE_DIR/latest/$OS/build-info.txt"
            fi
          done

      - name: Rebuild index.html
        shell: bash
        run: |
          SITE_DIR="site"
          echo "<html><head><title>Allure Reports History</title>
          <style>
          body{font-family:sans-serif;margin:20px;}
          ul{list-style:none;padding:0;}
          li{margin:6px 0;}
          a{text-decoration:none;color:#0366d6;}
          a:hover{text-decoration:underline;}
          </style></head><body>
          <h1>ü§ñ Robotics BDD Simulation CI/CD</h1>
          <h2>üß© Latest Allure Reports</h2><ul>" > "$SITE_DIR/index.html"

          for OS in ubuntu-latest windows-latest; do
            if [ -d "$SITE_DIR/latest/$OS" ]; then
              TS=$(cat "$SITE_DIR/latest/$OS/build-info.txt" 2>/dev/null || echo "(no timestamp)")
              echo "<li><a href='latest/$OS/'>Latest Report ($OS)</a> - Last run: $TS</li>" >> "$SITE_DIR/index.html"
            fi
          done

          echo "</ul><hr><h2>üìä Report History</h2><ul>" >> "$SITE_DIR/index.html"
          BUILDS=$(find "$SITE_DIR" -maxdepth 1 -type d -name "[0-9]*" | xargs -n 1 basename | sort -nr || true)
          for BUILD in $BUILDS; do
            for OS in ubuntu-latest windows-latest; do
              if [ -d "$SITE_DIR/$BUILD/$OS" ]; then
                TS=$(cat "$SITE_DIR/$BUILD/$OS/build-info.txt" 2>/dev/null || echo "(no timestamp)")
                echo "<li><a href='${BUILD}/${OS}/'>Build #${BUILD} ($OS)</a> - ${TS}</li>" >> "$SITE_DIR/index.html"
              fi
            done
          done
          echo "</ul><hr>
          <h3>üèÅ Build Result: <span style='color:#007700;'>${{ steps.build_result.outputs.status }}</span></h3>
          </body></html>" >> "$SITE_DIR/index.html"

      - name: Deploy Allure Site
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.SITE_DIR }}
